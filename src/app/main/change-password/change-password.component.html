<p-dialog header="Change Password" [(visible)]="visible" [modal]="true" [closable]="true" [dismissableMask]="true"
    [style]="{ width: '400px' }" (onHide)="onDialogClose()"
    [contentStyle]="{ 'overflow': 'visible', 'padding': '1.5rem' }">
    <div class="change-password-container animate__animated animate__fadeInDown">

        <!-- Step 1: Verify Current Password -->
        <ng-container *ngIf="!isVerified; else newPasswordForm">
            <form [formGroup]="verifyForm" class="password-form">
                <div class="form-field">
                    <label for="currentPassword">Current Password</label>
                    <p-password formControlName="currentPassword" [feedback]="false" [toggleMask]="true"
                        inputStyleClass="w-full" id="currentPassword"></p-password>

                    <small class="text-red-500"
                        *ngIf="verifyForm.get('currentPassword')?.invalid && verifyForm.get('currentPassword')?.touched">
                        Current password is required.
                    </small>
                </div>

                <button pButton label="Verify Password" icon="pi pi-check" (click)="verifyCurrentPassword()"
                    [loading]="verifying" class="w-full p-button-outlined" [disabled]="verifyForm.invalid"></button>
            </form>
        </ng-container>

        <!-- Step 2: Update New Password -->
        <ng-template #newPasswordForm>
            <form [formGroup]="updateForm" class="password-form">
                <div class="form-field">
                    <label for="newPassword">New Password</label>
                    <p-password formControlName="newPassword" autocomplete="off" [toggleMask]="true">
                        <ng-template #header>
                            <div class="font-semibold text-xm mb-4">Pick a password</div>
                        </ng-template>
                        <ng-template #footer>
                            <p-divider />
                            <ul class="pl-2 ml-2 my-0 leading-normal">
                                <li>At least one lowercase</li>
                                <li>At least one uppercase</li>
                                <li>At least one numeric</li>
                                <li>Minimum 8 characters</li>
                            </ul>
                        </ng-template>
                    </p-password>

                    <small class="text-red-500" style="display: block;"
                        *ngIf="updateForm.get('newPassword')?.invalid && updateForm.get('newPassword')?.touched">
                        Password must meet the requirements.
                    </small>
                </div>

                <div class="form-field">
                    <label for="confirmPassword">Confirm Password</label>
                    <p-password formControlName="confirmPassword" [feedback]="false" [toggleMask]="true"
                        inputStyleClass="w-full" id="confirmPassword"></p-password>

                    <small class="text-red-500"
                        *ngIf="updateForm.hasError('passwordMismatch') && updateForm.get('confirmPassword')?.touched">
                        Passwords do not match.
                    </small>
                </div>

                <button pButton label="Update Password" icon="pi pi-save" (click)="updatePassword()"
                    [loading]="updating" [disabled]="updateForm.invalid || updateForm.hasError('passwordMismatch')"
                    class="w-full p-button-rounded p-button-primary"></button>
            </form>
        </ng-template>

    </div>
</p-dialog>